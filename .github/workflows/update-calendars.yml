name: Update Calendars Daily

on:
  schedule:
    # Ejecutar todos los días a las 01:00 hora Argentina (UTC-3)
    # 01:00 ARG = 04:00 UTC
    - cron: '0 4 * * *'
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  update-calendars:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm install
        
    - name: Create service account file
      run: |
        echo '${{ secrets.SERVICE_ACCOUNT_JSON }}' > service-account.json
        echo "Verificando archivo service-account.json..."
        if [ -s service-account.json ]; then
          echo "✅ Archivo service-account.json creado correctamente"
          echo "Tamaño del archivo: $(wc -c < service-account.json) bytes"
          echo "Primeras líneas del archivo:"
          head -3 service-account.json
        else
          echo "❌ Error: El archivo service-account.json está vacío o no se pudo crear"
          echo "Contenido del secret:"
          echo '${{ secrets.SERVICE_ACCOUNT_JSON }}'
          exit 1
        fi
        
    - name: Update all calendars
      run: |
        node updateBothCalendars.js
      env:
        TZ: 'America/Argentina/Buenos_Aires'
        
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: calendar-update-logs
        path: '*.log'
        retention-days: 30
