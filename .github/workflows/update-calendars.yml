name: Update Calendars Daily

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 01:00 hora Argentina (UTC-3)
    # 01:00 ARG = 04:00 UTC
    - cron: '0 4 * * *'
  workflow_dispatch: # Permite ejecutar manualmente

jobs:
  update-calendars:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm install
        
    - name: Create service account file
      run: |
        echo '${{ secrets.SERVICE_ACCOUNT_JSON }}' > service-account.json
        echo "Verificando archivo service-account.json..."
        if [ -s service-account.json ]; then
          echo "âœ… Archivo service-account.json creado correctamente"
          echo "TamaÃ±o del archivo: $(wc -c < service-account.json) bytes"
          echo "Primeras lÃ­neas del archivo:"
          head -3 service-account.json
        else
          echo "âŒ Error: El archivo service-account.json estÃ¡ vacÃ­o o no se pudo crear"
          echo "Contenido del secret:"
          echo '${{ secrets.SERVICE_ACCOUNT_JSON }}'
          exit 1
        fi
        
    - name: Update all calendars
      run: |
        node updateBothCalendars.js
      env:
        TZ: 'America/Argentina/Buenos_Aires'
        
    - name: Display calendar subscription URLs
      if: success()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ“… URLs DE SUSCRIPCIÃ“N A LOS CALENDARIOS"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        
        # Calendario Live
        echo "ðŸŽµ CALENDARIO LIVE"
        echo "   ID: c_b1cdbb35e2e538d44729a8d7c06c6ae7349402a3eea9509b4332c5060ddd4d26@group.calendar.google.com"
        echo "   ðŸ“± URL pÃºblica (para suscribirse en Google Calendar):"
        echo "   https://calendar.google.com/calendar/u/0?cid=c_b1cdbb35e2e538d44729a8d7c06c6ae7349402a3eea9509b4332c5060ddd4d26%40group.calendar.google.com"
        echo "   ðŸ“¥ URL iCal pÃºblica (para otras aplicaciones - requiere calendario pÃºblico):"
        echo "   https://calendar.google.com/calendar/ical/c_b1cdbb35e2e538d44729a8d7c06c6ae7349402a3eea9509b4332c5060ddd4d26%40group.calendar.google.com/public/basic.ics"
        echo ""
        
        # Calendario Management
        echo "ðŸ“Š CALENDARIO MANAGEMENT"
        echo "   ID: c_7a6a9470388a244b85562ecb7268a773ca6d005d8bb142088a4d9abcd510e377@group.calendar.google.com"
        echo "   ðŸ“± URL pÃºblica (para suscribirse en Google Calendar):"
        echo "   https://calendar.google.com/calendar/u/0?cid=c_7a6a9470388a244b85562ecb7268a773ca6d005d8bb142088a4d9abcd510e377%40group.calendar.google.com"
        echo "   ðŸ“¥ URL iCal pÃºblica (para otras aplicaciones - requiere calendario pÃºblico):"
        echo "   https://calendar.google.com/calendar/ical/c_7a6a9470388a244b85562ecb7268a773ca6d005d8bb142088a4d9abcd510e377%40group.calendar.google.com/public/basic.ics"
        echo ""
        
        # Calendario Booking
        echo "ðŸ“… CALENDARIO BOOKING"
        echo "   ID: c_7fba15b73d470d9bfbf3e8708bf13f219cfe5128b3aec41415ff0bf3a6ca0f7e@group.calendar.google.com"
        echo "   ðŸ“± URL pÃºblica (para suscribirse en Google Calendar):"
        echo "   https://calendar.google.com/calendar/u/0?cid=c_7fba15b73d470d9bfbf3e8708bf13f219cfe5128b3aec41415ff0bf3a6ca0f7e%40group.calendar.google.com"
        echo "   ðŸ“¥ URL iCal pÃºblica (para otras aplicaciones - requiere calendario pÃºblico):"
        echo "   https://calendar.google.com/calendar/ical/c_7fba15b73d470d9bfbf3e8708bf13f219cfe5128b3aec41415ff0bf3a6ca0f7e%40group.calendar.google.com/public/basic.ics"
        echo ""
        
        # Calendario Records
        echo "ðŸ’¿ CALENDARIO RECORDS"
        echo "   ID: c_65f6f9dd7e6a17e03a9b3e50836b041dafb42f81bcdba13ac19a94ee75762592@group.calendar.google.com"
        echo "   ðŸ“± URL pÃºblica (para suscribirse en Google Calendar):"
        echo "   https://calendar.google.com/calendar/u/0?cid=c_65f6f9dd7e6a17e03a9b3e50836b041dafb42f81bcdba13ac19a94ee75762592%40group.calendar.google.com"
        echo "   ðŸ“¥ URL iCal pÃºblica (para otras aplicaciones - requiere calendario pÃºblico):"
        echo "   https://calendar.google.com/calendar/ical/c_65f6f9dd7e6a17e03a9b3e50836b041dafb42f81bcdba13ac19a94ee75762592%40group.calendar.google.com/public/basic.ics"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ’¡ CÃ“MO SUSCRIBIRSE:"
        echo "   1. Copia la URL pÃºblica (ðŸ“±) del calendario que quieras"
        echo "   2. Abre Google Calendar"
        echo "   3. Haz clic en el '+' junto a 'Otros calendarios'"
        echo "   4. Selecciona 'Por URL'"
        echo "   5. Pega la URL y haz clic en 'Agregar calendario'"
        echo ""
        echo "   Para aplicaciones externas (Outlook, Apple Calendar, etc.):"
        echo "   - Usa la URL iCal pÃºblica (ðŸ“¥) si el calendario es pÃºblico"
        echo "   - O usa la URL iCal privada desde la configuraciÃ³n del calendario"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: calendar-update-logs
        path: '*.log'
        retention-days: 30
